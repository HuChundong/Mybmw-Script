# -*- coding:utf-8 -*-
# date: 2023/3/1 17:49
# author: erxiaowang417
"""
功能：破解XXX的flutter SSL认证，让它以为证书是正常的
    1. 启动需要注入APP
    2. adb 连接
    3. cmd: adb shell  cd /data/local/tmp  以root ./frida-server，root需要su
    4. 端口映射: adb forward tcp:27042 tcp:27042  adb forward tcp:27043 tcp:27043，这一步可有可无，frida-ps —R失败则需要转发
    5. 运行verify found at: 0xxxxxxxxx(内存对应地址) 表示注入成功
"""
import frida
import sys

jscode = """

var version_='jsjiami.com.v7';(function(_0x3555fe,_0x57c64e,_0x39b7a9,_0x3d264d,_0xbe586f,_0x4b3d35,_0x10b769){return _0x3555fe=_0x3555fe>>0x7,_0x4b3d35='hs',_0x10b769='hs',function(_0x3a9759,_0x28b84c,_0x3bce37,_0x23a4c2,_0x12c4dd){var _0x18b003=_0x3477;_0x23a4c2='tfi',_0x4b3d35=_0x23a4c2+_0x4b3d35,_0x12c4dd='up',_0x10b769+=_0x12c4dd,_0x4b3d35=_0x3bce37(_0x4b3d35),_0x10b769=_0x3bce37(_0x10b769),_0x3bce37=0x0;var _0x4cdb15=_0x3a9759();while(!![]&&--_0x3d264d+_0x28b84c){try{_0x23a4c2=parseInt(_0x18b003(0x1dd,'TqXW'))/0x1+parseInt(_0x18b003(0x1fc,'I(7I'))/0x2+-parseInt(_0x18b003(0x212,'s8^l'))/0x3+parseInt(_0x18b003(0x1df,'(1Vb'))/0x4+-parseInt(_0x18b003(0x1de,'Hj#I'))/0x5*(parseInt(_0x18b003(0x1ff,']DY('))/0x6)+-parseInt(_0x18b003(0x1db,'&jp4'))/0x7+-parseInt(_0x18b003(0x1fa,'TqXW'))/0x8*(-parseInt(_0x18b003(0x1f7,'P%ey'))/0x9);}catch(_0x15e3b0){_0x23a4c2=_0x3bce37;}finally{_0x12c4dd=_0x4cdb15[_0x4b3d35]();if(_0x3555fe<=_0x3d264d)_0x3bce37?_0xbe586f?_0x23a4c2=_0x12c4dd:_0xbe586f=_0x12c4dd:_0x3bce37=_0x12c4dd;else{if(_0x3bce37==_0xbe586f['replace'](/[QVAyEKnYfCTMXbFNWOJ=]/g,'')){if(_0x23a4c2===_0x28b84c){_0x4cdb15['un'+_0x4b3d35](_0x12c4dd);break;}_0x4cdb15[_0x10b769](_0x12c4dd);}}}}}(_0x39b7a9,_0x57c64e,function(_0x2371cf,_0x1833b0,_0x2c0082,_0x2fb97f,_0x25c120,_0x43f339,_0x2c9948){return _0x1833b0='\x73\x70\x6c\x69\x74',_0x2371cf=arguments[0x0],_0x2371cf=_0x2371cf[_0x1833b0](''),_0x2c0082=`\x72\x65\x76\x65\x72\x73\x65`,_0x2371cf=_0x2371cf[_0x2c0082]('\x76'),_0x2fb97f=`\x6a\x6f\x69\x6e`,(0x1224c9,_0x2371cf[_0x2fb97f](''));});}(0x6680,0xd00e6,_0x4dba,0xcf),_0x4dba)&&(version_=_0x4dba);function hook_flutter(){var _0x16f1ac=_0x3477,_0xc7732={'xRiNl':_0x16f1ac(0x21c,'k4%0'),'pOLQI':_0x16f1ac(0x213,'ESb&'),'vbntN':_0x16f1ac(0x1fd,'Hj#I'),'ZqusJ':_0x16f1ac(0x204,'qT])'),'SfWdK':_0x16f1ac(0x1f4,'5WPB'),'XXnTC':_0x16f1ac(0x209,'[A7n'),'eeoWR':_0x16f1ac(0x1e0,'i#HL'),'fLQJP':'FF\x20C3\x2001\x20D1\x20FD\x207B\x2001\x20A9\x20FC\x206F','nYsYE':_0x16f1ac(0x20a,'ZV*V')};Java[_0x16f1ac(0x1e6,'s8^l')](function(){var _0x206cc3=_0x16f1ac,_0x423971={'SBRox':_0xc7732[_0x206cc3(0x21b,'(aKo')],'dsMYz':function(_0x1d423a,_0x3c3102){return _0x1d423a(_0x3c3102);},'ALOdd':_0xc7732['pOLQI'],'mMIZo':_0xc7732['ZqusJ'],'hdpYu':function(_0x3ca311,_0x35fe28){return _0x3ca311!==_0x35fe28;},'lFteC':_0xc7732[_0x206cc3(0x1f1,'8#bv')],'mGFgD':_0xc7732[_0x206cc3(0x1ef,'8#bv')],'LEGWJ':_0xc7732['eeoWR']},_0x112b87=Process[_0x206cc3(0x208,'(1Vb')](_0xc7732['ZqusJ']),_0x14742f=_0xc7732[_0x206cc3(0x20f,'ESb&')];_0x14742f+=_0xc7732['nYsYE'];var _0x38f9d8=Memory[_0x206cc3(0x1e5,'vzNI')](_0x112b87[_0x206cc3(0x1eb,'Bm16')],_0x112b87[_0x206cc3(0x1e4,'XZQA')],_0x14742f,{'onMatch':function(_0x45e815,_0xc30445){var _0x1170a0=_0x206cc3,_0x20fab7={'PrUec':_0x423971[_0x1170a0(0x1f5,'Tr*X')],'VXMhJ':function(_0x3b47d,_0x3d615f){var _0x27a514=_0x1170a0;return _0x423971[_0x27a514(0x210,'Kfse')](_0x3b47d,_0x3d615f);},'PkfST':_0x423971[_0x1170a0(0x214,'!UYd')],'RHchd':_0x1170a0(0x1e7,'Tr*X'),'fhOWe':_0x423971[_0x1170a0(0x201,'%pt6')],'ffcDP':_0x1170a0(0x20c,'#zG4'),'uBHPT':_0x1170a0(0x1f8,'@qwq')};if(_0x423971[_0x1170a0(0x1f2,')ETd')](_0x423971[_0x1170a0(0x1ee,'CLET')],_0x423971[_0x1170a0(0x1e8,'Bm16')]))console[_0x1170a0(0x20d,'i#HL')](_0x423971[_0x1170a0(0x20b,'vzNI')]+_0x45e815[_0x1170a0(0x1e3,'2j6@')]()),hook_ssl_verify_result(_0x45e815);else{var _0x4e291d={'heJOy':_0x20fab7[_0x1170a0(0x206,'[A7n')]},_0x297880=_0x4f4a9f[_0x1170a0(0x21d,'8*Ts')](_0x20fab7[_0x1170a0(0x218,'&jp4')]),_0x8a9d46=_0x20fab7[_0x1170a0(0x1ed,'Ig!W')];_0x8a9d46+=_0x20fab7[_0x1170a0(0x219,'GqUf')];var _0x502b9c=_0x526884['scan'](_0x297880['base'],_0x297880[_0x1170a0(0x1f0,'*6Ev')],_0x8a9d46,{'onMatch':function(_0x4746e1,_0x1e595e){var _0x124d90=_0x1170a0;_0x54cc09['log'](_0x20fab7[_0x124d90(0x205,'vzNI')]+_0x4746e1['toString']()),_0x20fab7[_0x124d90(0x1e1,'GqUf')](_0x1a4cb7,_0x4746e1);},'onError':function(_0x510e47){var _0x56e3c9=_0x1170a0;_0x310084['log'](_0x4e291d[_0x56e3c9(0x1f9,'qT])')]);},'onComplete':function(){var _0x3c3ab4=_0x1170a0;_0x1d8168[_0x3c3ab4(0x1e9,'P%ey')](_0x20fab7[_0x3c3ab4(0x1fb,'vzNI')]);}});}},'onError':function(_0x3117c0){console['log'](_0x423971['LEGWJ']);},'onComplete':function(){var _0x3b8d76=_0x206cc3;_0x3b8d76(0x216,'Atl8')!==_0xc7732[_0x3b8d76(0x215,'qT])')]?console[_0x3b8d76(0x20e,'xX0U')](_0xc7732[_0x3b8d76(0x202,'5WPB')]):_0x4f2255['log'](_0x423971[_0x3b8d76(0x1ec,'i#HL')]);}});});}function hook_ssl_verify_result(_0x1683cc){var _0x448e19=_0x3477,_0x57f31a={'TUnNW':_0x448e19(0x1fe,'TqXW'),'QdEGM':_0x448e19(0x1f3,'Uem4')};_0x1683cc=_0x1683cc,Interceptor[_0x448e19(0x1f6,'P%ey')](_0x1683cc,{'onEnter':function(_0x3af221){var _0x577be2=_0x448e19;console['log'](_0x57f31a[_0x577be2(0x1e2,'vzNI')]);},'onLeave':function(_0x314ec8){var _0x2f03c9=_0x448e19;console['log'](_0x57f31a[_0x2f03c9(0x1ea,'Atl8')]+_0x314ec8),_0x314ec8['replace'](0x1);}});}setImmediate(hook_flutter);function _0x3477(_0x5814f9,_0x457d43){var _0x4dbad6=_0x4dba();return _0x3477=function(_0x3477c0,_0x3c1f5c){_0x3477c0=_0x3477c0-0x1db;var _0x407060=_0x4dbad6[_0x3477c0];if(_0x3477['XqAdfu']===undefined){var _0x37a9f5=function(_0x4656c1){var _0xeefe5d='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=';var _0x4eb1bc='',_0x3197df='';for(var _0xc8e469=0x0,_0x4f4a9f,_0x526884,_0x197a50=0x0;_0x526884=_0x4656c1['charAt'](_0x197a50++);~_0x526884&&(_0x4f4a9f=_0xc8e469%0x4?_0x4f4a9f*0x40+_0x526884:_0x526884,_0xc8e469++%0x4)?_0x4eb1bc+=String['fromCharCode'](0xff&_0x4f4a9f>>(-0x2*_0xc8e469&0x6)):0x0){_0x526884=_0xeefe5d['indexOf'](_0x526884);}for(var _0x11eef1=0x0,_0x50ef99=_0x4eb1bc['length'];_0x11eef1<_0x50ef99;_0x11eef1++){_0x3197df+='%'+('00'+_0x4eb1bc['charCodeAt'](_0x11eef1)['toString'](0x10))['slice'](-0x2);}return decodeURIComponent(_0x3197df);};var _0x1b24ed=function(_0x6b22ed,_0x54cc09){var _0x1a4cb7=[],_0x310084=0x0,_0x1d8168,_0x3abc4c='';_0x6b22ed=_0x37a9f5(_0x6b22ed);var _0x58e0cb;for(_0x58e0cb=0x0;_0x58e0cb<0x100;_0x58e0cb++){_0x1a4cb7[_0x58e0cb]=_0x58e0cb;}for(_0x58e0cb=0x0;_0x58e0cb<0x100;_0x58e0cb++){_0x310084=(_0x310084+_0x1a4cb7[_0x58e0cb]+_0x54cc09['charCodeAt'](_0x58e0cb%_0x54cc09['length']))%0x100,_0x1d8168=_0x1a4cb7[_0x58e0cb],_0x1a4cb7[_0x58e0cb]=_0x1a4cb7[_0x310084],_0x1a4cb7[_0x310084]=_0x1d8168;}_0x58e0cb=0x0,_0x310084=0x0;for(var _0x3deacb=0x0;_0x3deacb<_0x6b22ed['length'];_0x3deacb++){_0x58e0cb=(_0x58e0cb+0x1)%0x100,_0x310084=(_0x310084+_0x1a4cb7[_0x58e0cb])%0x100,_0x1d8168=_0x1a4cb7[_0x58e0cb],_0x1a4cb7[_0x58e0cb]=_0x1a4cb7[_0x310084],_0x1a4cb7[_0x310084]=_0x1d8168,_0x3abc4c+=String['fromCharCode'](_0x6b22ed['charCodeAt'](_0x3deacb)^_0x1a4cb7[(_0x1a4cb7[_0x58e0cb]+_0x1a4cb7[_0x310084])%0x100]);}return _0x3abc4c;};_0x3477['KtSTbV']=_0x1b24ed,_0x5814f9=arguments,_0x3477['XqAdfu']=!![];}var _0x49918c=_0x4dbad6[0x0],_0xc207b0=_0x3477c0+_0x49918c,_0x569d7e=_0x5814f9[_0xc207b0];return!_0x569d7e?(_0x3477['VYRNPN']===undefined&&(_0x3477['VYRNPN']=!![]),_0x407060=_0x3477['KtSTbV'](_0x407060,_0x3c1f5c),_0x5814f9[_0xc207b0]=_0x407060):_0x407060=_0x569d7e,_0x407060;},_0x3477(_0x5814f9,_0x457d43);}function _0x4dba(){var _0x3b7400=(function(){return[...[version_,'AyjybWsJjniTamCiMY.KXcKboQm.VXFvN7fnEFOW==','jSospW8rhb1WWPbXwG','WPpcTmkUWOiW','zCkTqMHG','lmospGOrqWDkWRneFCk4','r0CAjCo7kSogW6BdPSoFW7KfW44','lSoJbCo8W4S','WOzuW6VdTmk/','g8kyW5pcQ8kcWPSkz8kbdmkmsmkVFW','W61lkqePW7NdGCkfWOC4WO0LW6OaB8kv','WRn0W67dRCkw','W41aB1f/eCoGuMKOiW8AWQBdLbldJmkMxb0EnSkmySkjAmoliGL2WRTfbKNdQsC2jLfKWPFdLfddJ0ZdQCovW6jKgmonW4iqELddSCklcHyaW4VdJSk+kr5EeweLbCkNjMpdNa3cHWtdQW','lCotaSo2W5a','W5apsqX7eCkpW4FcKsOHFIviW5jkW47cH8oHWR4RFmozWOCKdGhcUCox','WOGSEW','ohBdLW','WQldNq93tq','WQa4a8k0jq','WQVcRYJcVx7dHSoHW7mPWPu1F1hcIW','WOyDftZcJ2ldJrRcSepdQSk8wa','WOxdVtiDECoeWPjG','iCoecG7dNa','u3WrdCo7'],...(function(){return[...['fGrBESkT','WR3cTwRcV8kBDcG4','W5hdICkJBSk2','wulcOCofBG','WQpdImohW5XSWQqrW6RdUa','xmooWOZdR8o4','W4xdIKpcLSkK','W5xdTvVdVmotBmo2hHaxWPpdP8klW7NdQgi','WOBcKCoFdSoJW4OqW79nWQxdG8o+wda','W6TvW6OtywldIg3cV28GWPtcVW','omoPW5TIWORdG1lcQ8oMWOu','WRFdM8oWWRCXW47dTmoanq','WRisD1zCWQBdICk9WOq/WOOY','WR9IqCoGW6BcQgRdG2JdJHBcMmofWP5HfCo/W5JcQ8kIWP1eumkFW7VcO8kDDgCmtZm4oCoxphtcSq','ELJcPmo9Ca','kSoepSoxW78','DSoJW6vQWP9+WQCj','pSoZW4nr','dCoYmCo3','W4rbxM3dKsJcLG','k8kJW50OCSotlmkBh3aZCaldUrxcJsldRXqVWQyQuJ0MuMFcPCk9W5zrhmkFW7WOWPxcRmo/','WOZcKdtdRKy','W6RdGSkk','dGHozmkR'],...(function(){return['WOpcTGhdRa','WQupu8kKW5y','W4RcO3pcJSox','u346DYS','W4ZcPmkCW71v','W6NdTMhdRW','W4FcMSkLW41D','W4D0ECocsW','W708kSk0W7NcUCoWtq','ymkqwNDO','i8oaW5jNxG','W6FdMCkzWOe6WRe','WRFcMCoCW5bTW6HTWPlcJSkZa8kBWPiO','pY7cLSofW7WOzH5hlcJcSCosyWJcQmoUzSk9yHNdMIJdT2pdMSo+W44IiYlcH8kJWRJdPmoJWQjwWQBdVvpcSthdQqieoxtcR8kvWP7cUaWVf8oJjCkuW4dcRWS9odZdIZbkW5TAoSkTqhXbDG5CWR8','q0SYdmoU','pmoTWQK9WQZdU2ZcUa','lSo6nSokW7W','jKFcLdqhpCoMWOjWwqFcOJ8','W5VdHmkyW6i9W7pdKCopjSkOW4m+fbtcNINcTSkhW7hcTCkNWOzuW4aJWOZcTmkJ','sCkYWPe2WQddNvFcL8okW6eFzdHIFmoEexJcLJq','WRHwCxSEWPpdTLlcHSoCFG'];}())];}())];}());_0x4dba=function(){return _0x3b7400;};return _0x4dba();};var version_ = 'jsjiami.com.v7';

"""

def on_message(message, data):
    if message['type'] == 'send':
        print("[*] {0}".format(message['payload']))
    else:
        print(message)
print(frida.get_usb_device())
print(frida.get_remote_device())
# 注入
process = frida.get_usb_device().attach("My BMW")
print(process)
script = process.create_script(jscode)
script.on('message', on_message)
script.load()
sys.stdin.read()
