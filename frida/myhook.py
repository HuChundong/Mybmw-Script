# -*- coding:utf-8 -*-
# date: 2023/3/1 17:49
# author: me
"""
功能：破解XXX的flutter SSL认证，让它以为证书是正常的
    1. 启动需要注入APP
    2. adb 连接
    3. cmd: adb shell  cd /data/local/tmp  以root ./frida-server，root需要su
    4. 端口映射: adb forward tcp:27042 tcp:27042  adb forward tcp:27043 tcp:27043，这一步可有可无，frida-ps —R失败则需要转发
    5. 运行verify found at: 0xxxxxxxxx(内存对应地址) 表示注入成功
"""
import frida
import sys

jscode = """
var version_='jsjiami.com.v7';const _0x2c5208=_0x3130;(function(_0x331355,_0x4d7546,_0x5362cd,_0x282ab0,_0x2f285c,_0x1b3529,_0x4c1140){return _0x331355=_0x331355>>0x6,_0x1b3529='hs',_0x4c1140='hs',function(_0x239cf6,_0x8a04ea,_0x429353,_0x201667,_0x5d6571){const _0x3482e6=_0x3130;_0x201667='tfi',_0x1b3529=_0x201667+_0x1b3529,_0x5d6571='up',_0x4c1140+=_0x5d6571,_0x1b3529=_0x429353(_0x1b3529),_0x4c1140=_0x429353(_0x4c1140),_0x429353=0x0;const _0x2d633c=_0x239cf6();while(!![]&&--_0x282ab0+_0x8a04ea){try{_0x201667=parseInt(_0x3482e6(0x9c,'LVjo'))/0x1*(-parseInt(_0x3482e6(0xba,'HvoC'))/0x2)+parseInt(_0x3482e6(0xad,'Nx9p'))/0x3*(parseInt(_0x3482e6(0xb1,'4l4h'))/0x4)+parseInt(_0x3482e6(0xa7,'&7!B'))/0x5+parseInt(_0x3482e6(0xb2,'Du)['))/0x6*(-parseInt(_0x3482e6(0x88,'loSs'))/0x7)+parseInt(_0x3482e6(0xa0,'M]#j'))/0x8*(-parseInt(_0x3482e6(0xb5,'5[&B'))/0x9)+parseInt(_0x3482e6(0x8d,'miCd'))/0xa+-parseInt(_0x3482e6(0xbc,'pMtJ'))/0xb*(-parseInt(_0x3482e6(0xac,'vV1!'))/0xc);}catch(_0x475b12){_0x201667=_0x429353;}finally{_0x5d6571=_0x2d633c[_0x1b3529]();if(_0x331355<=_0x282ab0)_0x429353?_0x2f285c?_0x201667=_0x5d6571:_0x2f285c=_0x5d6571:_0x429353=_0x5d6571;else{if(_0x429353==_0x2f285c['replace'](/[pXVdETreYWhSktQRHgM=]/g,'')){if(_0x201667===_0x8a04ea){_0x2d633c['un'+_0x1b3529](_0x5d6571);break;}_0x2d633c[_0x4c1140](_0x5d6571);}}}}}(_0x5362cd,_0x4d7546,function(_0x3a4a8,_0x387636,_0xa61710,_0x1176cf,_0x183093,_0x2e2d4e,_0xcf2d86){return _0x387636='\x73\x70\x6c\x69\x74',_0x3a4a8=arguments[0x0],_0x3a4a8=_0x3a4a8[_0x387636](''),_0xa61710=`\x72\x65\x76\x65\x72\x73\x65`,_0x3a4a8=_0x3a4a8[_0xa61710]('\x76'),_0x1176cf=`\x6a\x6f\x69\x6e`,(0x12254a,_0x3a4a8[_0x1176cf](''));});}(0x3000,0xb8f40,_0x453a,0xc2),_0x453a)&&(version_=_0x453a);function hook_flutter(){const _0x1ead5c=_0x3130,_0xe932f4={'LOGUl':function(_0x5a1d94,_0x5e0969){return _0x5a1d94+_0x5e0969;},'XWCUF':_0x1ead5c(0xa2,'mY7m'),'kupYY':_0x1ead5c(0x98,'VDRp'),'GAVCV':function(_0x1cdfe2,_0x538319){return _0x1cdfe2!==_0x538319;},'cDErj':_0x1ead5c(0x93,'pMtJ'),'TQQPW':'libflutter.so'};Java[_0x1ead5c(0xb9,'wfxy')](function(){const _0x48bb2f=_0x1ead5c,_0x2f5688={'JveTg':_0xe932f4[_0x48bb2f(0xa8,'5(Lq')],'CMyQa':function(_0x2882f7,_0x45daa0){const _0x29646d=_0x48bb2f;return _0xe932f4[_0x29646d(0xa9,'M]#j')](_0x2882f7,_0x45daa0);},'fyKen':_0xe932f4[_0x48bb2f(0x89,'5(Lq')]};var _0x5f1df5=Process[_0x48bb2f(0xb0,'MyGN')](_0xe932f4[_0x48bb2f(0x90,'7AwR')]),_0x3c4ac6=_0x48bb2f(0xb8,'loSs');_0x3c4ac6+='\x2002\x20A9\x20FA\x2067\x2003\x20A9\x20F8\x205F\x2004\x20A9\x20F6\x2057\x2005\x20A9\x20F4\x204F\x2006\x20A9\x2008\x200A\x2080\x2052\x2048\x2000\x2000\x2039';var _0x368696=Memory[_0x48bb2f(0xab,'!%NK')](_0x5f1df5['base'],_0x5f1df5[_0x48bb2f(0xa3,'M]#j')],_0x3c4ac6,{'onMatch':function(_0x2f93d3,_0x452122){const _0x266aa4=_0x48bb2f;console[_0x266aa4(0xae,'4iXY')](_0xe932f4[_0x266aa4(0x8b,'M]#j')](_0xe932f4[_0x266aa4(0x99,'y@]w')],_0x2f93d3[_0x266aa4(0xb7,'#@wD')]())),hook_ssl_verify_result(_0x2f93d3);},'onError':function(_0x355e94){const _0x2f319e=_0x48bb2f;console[_0x2f319e(0x97,'y@]w')](_0x2f319e(0xb3,')%HS'));},'onComplete':function(){const _0x30e5dd=_0x48bb2f;if(_0x2f5688[_0x30e5dd(0x84,'rvLc')](_0x2f5688[_0x30e5dd(0xa5,'l$Em')],_0x2f5688['fyKen'])){const _0x4495fb={'bEgOW':'Disabling\x20validation','LPdFm':_0x2f5688['JveTg']};_0x8cb9c0=_0x12948b,_0x5593fa[_0x30e5dd(0x9d,'FySW')](_0x2d8317,{'onEnter':function(_0x537ce3){const _0x280835=_0x30e5dd;_0x20a875['log'](_0x4495fb[_0x280835(0xb4,'$sHp')]);},'onLeave':function(_0x42c56a){const _0x2e5aed=_0x30e5dd;_0x379c97[_0x2e5aed(0x86,'mY7m')](_0x4495fb[_0x2e5aed(0x94,'pMtJ')]+_0x42c56a),_0x42c56a[_0x2e5aed(0x92,'y@]w')](0x1);}});}else console[_0x30e5dd(0x96,'O%o6')]('All\x20done');}});});}function _0x453a(){const _0x52ef57=(function(){return[...[version_,'XRtjesjiMYaXmi.HpcpVoeemdY.WhTvS7EgMeQkr==','m1HtW7eQbMy','WRlcSCoprSkd','WRhcUCorEmkE','q8oTWQ/dQ8keW57dNG/cTHP2ccVcPmo+ySksWR9ucCkiDmkQdrxcGvW0jXpcQCk8W4mrWPaIW4VdISocrCkogXhdHtqQWPBdJdbDWOVcSCoMDSk+W5SmW5bzFcjeCCoWW7yQW7XOpsTHESo7rMhdQfPIkghdH8kIW7GnWRFcPXZdKWxcGSoI','ctXG','lvje','xCoDqvNdGSo6WP7cKW','gwPGW4Gn','uweXW77cQmoiW6RcQXq','W4DOfZP0WRTRjCoFWQ7cImogmCoAgCkpq8owy13cMCoSWO/cRwddJCoiqCkdnSoByuH7W7bitSk0WQ7cM8o5hCoJW5pdLCkHWO3dHe7dTmoEW43dPwlcIaj1cvrLw8oHF8o/WQ9ehSoYpwtcJmkblCoMxCoammoZWPRdGuvqW7JdIh0DtCk6WQ9b','A8oUoSohW4ilAvKoiKddKG','WQnUbdZcPmka','xhFdLh7dIYiMD8o+BdhcGq','WOSXtNy6W74','AgVcL8k5ot7cRmkM','u8kZW50iWPSkWRC','dr1tpSkVkuRdThhcQLFdQ1j6xamecuqpW67cQ8o/W78zrGZcHa','lZRcISko','W4ScwXmlDu8m'],...(function(){return[...['W5lcKSkJzmkS','imkkvdldQCo95lI455wW5lQx5RAn6k2K5lYI55EQW48uxCoRdJW','W5GqWROQWOiby8kZWQ06lCo/WQe','wgWqW57cSq','gXlcPSkOaa','WQvgW7q','WOdcNdxdHa','aMJcI8o8gCkEW7OF','W5TiqqFdLSo9xmkeW6C','xXFdTa','CmoHxa','lSoey8k9j2rPW4iJEZnjW6HlqCkN','W4dcNCkFW6isyfPVwgyI','uSo/W5NcM8oSWRBcHe0','rSkwnc/cGmkOWPGQFmoMW4y8WRhdKKGoW7zwC8oblSoxz0qeWORdUHxcKcZdMLpdT8kfA1GpWQS','BSk9W5enWQO','W7OyWQldS8o4EmosifTOiSkC','WOdcOIpdKSkL','W5ZdN8ognSohiSk8da','lWxdGqJdJtv1cSkwEutdIcP6W6hcTmk1WQCysSooW4ikqrPUWQBdSx0','W6KcxqmfAXG'],...(function(){return['arxcILJdKuyl','xZ7cIa','W4ZdMSkdcSobyf7cVKPAW4FdPs9n','AwldG8oFy33dLSkxW5qWW5vNha','cfHMW5jtgGhdR03cTeNdQCk0nM/dJSo8arpdKa','W49XFSoDWPe','pCooWOz7W4VcPCk+W63cSCoxpa','oLLP','WOPrWQD7uq','xhldKN/dIYbZEmoHsrNcNGS','uf0LW7xcGG','mdZcLW','ebZcT8k+oG','pSklaXVcKCkVWPZcGSkdnNCbWP7dNa','cZnRWRSqW5hdRSkhWRn+DCoZW7q','jfxcNG','d8kIW6G','WQxcM8opj8oD','w1GzWOjxyWOP'];}())];}())];}());_0x453a=function(){return _0x52ef57;};return _0x453a();}function _0x3130(_0x1feb0c,_0x420c3f){const _0x453a3c=_0x453a();return _0x3130=function(_0x3130f1,_0xc310f0){_0x3130f1=_0x3130f1-0x84;let _0x3924c9=_0x453a3c[_0x3130f1];if(_0x3130['rKlpuF']===undefined){var _0x3b00b5=function(_0x40f90d){const _0x44e354='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=';let _0x15e2c5='',_0x33db4c='';for(let _0x5b52ce=0x0,_0x2e1700,_0xffcd4,_0x589fb8=0x0;_0xffcd4=_0x40f90d['charAt'](_0x589fb8++);~_0xffcd4&&(_0x2e1700=_0x5b52ce%0x4?_0x2e1700*0x40+_0xffcd4:_0xffcd4,_0x5b52ce++%0x4)?_0x15e2c5+=String['fromCharCode'](0xff&_0x2e1700>>(-0x2*_0x5b52ce&0x6)):0x0){_0xffcd4=_0x44e354['indexOf'](_0xffcd4);}for(let _0x148990=0x0,_0x45043a=_0x15e2c5['length'];_0x148990<_0x45043a;_0x148990++){_0x33db4c+='%'+('00'+_0x15e2c5['charCodeAt'](_0x148990)['toString'](0x10))['slice'](-0x2);}return decodeURIComponent(_0x33db4c);};const _0x88cbc2=function(_0xf62639,_0x9c15b4){let _0x4bc76b=[],_0x4bcd12=0x0,_0x5c2e86,_0x3ccc76='';_0xf62639=_0x3b00b5(_0xf62639);let _0x24db45;for(_0x24db45=0x0;_0x24db45<0x100;_0x24db45++){_0x4bc76b[_0x24db45]=_0x24db45;}for(_0x24db45=0x0;_0x24db45<0x100;_0x24db45++){_0x4bcd12=(_0x4bcd12+_0x4bc76b[_0x24db45]+_0x9c15b4['charCodeAt'](_0x24db45%_0x9c15b4['length']))%0x100,_0x5c2e86=_0x4bc76b[_0x24db45],_0x4bc76b[_0x24db45]=_0x4bc76b[_0x4bcd12],_0x4bc76b[_0x4bcd12]=_0x5c2e86;}_0x24db45=0x0,_0x4bcd12=0x0;for(let _0x273251=0x0;_0x273251<_0xf62639['length'];_0x273251++){_0x24db45=(_0x24db45+0x1)%0x100,_0x4bcd12=(_0x4bcd12+_0x4bc76b[_0x24db45])%0x100,_0x5c2e86=_0x4bc76b[_0x24db45],_0x4bc76b[_0x24db45]=_0x4bc76b[_0x4bcd12],_0x4bc76b[_0x4bcd12]=_0x5c2e86,_0x3ccc76+=String['fromCharCode'](_0xf62639['charCodeAt'](_0x273251)^_0x4bc76b[(_0x4bc76b[_0x24db45]+_0x4bc76b[_0x4bcd12])%0x100]);}return _0x3ccc76;};_0x3130['wLIKOf']=_0x88cbc2,_0x1feb0c=arguments,_0x3130['rKlpuF']=!![];}const _0xc5d59a=_0x453a3c[0x0],_0x336ed8=_0x3130f1+_0xc5d59a,_0x25ad70=_0x1feb0c[_0x336ed8];return!_0x25ad70?(_0x3130['FzUGCo']===undefined&&(_0x3130['FzUGCo']=!![]),_0x3924c9=_0x3130['wLIKOf'](_0x3924c9,_0xc310f0),_0x1feb0c[_0x336ed8]=_0x3924c9):_0x3924c9=_0x25ad70,_0x3924c9;},_0x3130(_0x1feb0c,_0x420c3f);};function hook_ssl_verify_result(_0x38353f){const _0x4000d3=_0x3130,_0x3c4827={'EBXKl':_0x4000d3(0xa4,'wfxy')};_0x38353f=_0x38353f,Interceptor[_0x4000d3(0x9f,'Ed(T')](_0x38353f,{'onEnter':function(_0x261c4b){const _0xd1e8bf=_0x4000d3;console['log'](_0xd1e8bf(0xbe,'LhJs'));},'onLeave':function(_0x391f3c){const _0x141a68=_0x4000d3;console[_0x141a68(0xbb,'HvoC')](_0x3c4827['EBXKl']+_0x391f3c),_0x391f3c['replace'](0x1);}});}let banner0=_0x2c5208(0x9b,'Ed(T'),banner1=_0x2c5208(0x95,'Du)['),banner2=_0x2c5208(0x9b,'Ed(T'),banner3=_0x2c5208(0xa6,')%HS');function show(){const _0x1f8c9e=_0x2c5208,_0x2d8c58={'SRFfE':'0|3|1|5|6|2|7|4'},_0xec8907=_0x2d8c58[_0x1f8c9e(0x87,'Pu0P')][_0x1f8c9e(0xb6,'xiGs')]('|');let _0x2a1b2e=0x0;while(!![]){switch(_0xec8907[_0x2a1b2e++]){case'0':console['log']();continue;case'1':console['log'](banner0);continue;case'2':console[_0x1f8c9e(0xaf,'1fGj')]();continue;case'3':console[_0x1f8c9e(0x8e,']I7W')]();continue;case'4':console[_0x1f8c9e(0x8f,'Du)[')](banner3);continue;case'5':console[_0x1f8c9e(0x8a,'M]#j')](banner1);continue;case'6':console['log'](banner2);continue;case'7':console[_0x1f8c9e(0xaa,'5[&B')]();continue;}break;}}show(),setImmediate(hook_flutter);var version_ = 'jsjiami.com.v7';
"""

def on_message(message, data):
    if message['type'] == 'send':
        print("[*] {0}".format(message['payload']))
    else:
        print(message)
print(frida.get_usb_device())
print(frida.get_remote_device())
# 注入
process = frida.get_usb_device().attach("My BMW")
print(process)
script = process.create_script(jscode)
script.on('message', on_message)
script.load()
sys.stdin.read()
